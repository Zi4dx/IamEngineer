import React, { useState, useEffect, useMemo } from 'react';
import { 
  Search, 
  Calendar, 
  Clock, 
  MapPin, 
  User, 
  BookOpen, 
  Filter, 
  X, 
  Moon, 
  Sun,
  GraduationCap,
  LayoutGrid,
  List,
  Radio,
  Timer
} from 'lucide-react';

// --- البيانات الدراسية ---
const scheduleData = {
    'السبت': {
        '8:00 ص - 10:00 ص': [
            { subject: 'رياضة 1', instructor: 'د. علي فرحات', room: '202' },
            { subject: 'ديناميكا حرارية 1', instructor: 'أ. فرج الكيلاني', room: '203' },
            { subject: 'تصميم معماري 2', instructor: 'د. يوسف طاهر', room: '206' },
            { subject: 'كيمياء', instructor: 'أ. فاطمة ابوتبينة', room: '209' },
            { subject: 'رياضة 3', instructor: 'د. عبد الناصر القعود', room: '306' },
        ],
        '10:00 ص - 12:00 م': [
            { subject: 'تحكم آلي ميكانيكي', instructor: 'عبد السلام القهواجي', room: '301' },
            { subject: 'تصميم خرسانة 3', instructor: 'محمد شكشك', room: '303' },
            { subject: 'إلكترونيات تماثلية', instructor: 'د. سالم الهمالي', room: '308' },
            { subject: 'نظرية إنشاءات 2', instructor: 'أ. أحمد العيان', room: '309' },
        ],
        '12:00 م - 2:00 م': [
            { subject: 'ميكانيكا هندسية 1', instructor: 'أ. أسالم بلعيد', room: '202' },
            { subject: 'ميكانيكا هندسية 1', instructor: 'أ. أيمن الكوت', room: '203' },
            { subject: 'نظريات ومبادئ التخطيط', instructor: 'د. قراض', room: '206' },
            { subject: 'لغة إنجليزية 2', instructor: 'د. محمد البحبوح', room: '208' },
            { subject: 'هندسة وصفية', instructor: 'أ. سالم خوجة', room: '209' },
            { subject: 'رصف طرق', instructor: 'أ. طارق شميلة', room: '301' },
            { subject: 'نظريات عمارة', instructor: 'د. يوسف طاهر', room: '303' },
            { subject: 'فيزياء 2', instructor: 'أ. محمد ابوسنينة', room: '304' },
            { subject: 'إلكترونيات رقمية', instructor: 'د. سالم الهمالي', room: '308' },
            { subject: 'تصميم خرسانة 1', instructor: 'أ. أحمد العيان', room: '309' },
            { subject: 'أنظمة تحكم 1', instructor: 'أ. أحمد العاتي', room: '310' },
        ],
        '2:00 م - 4:00 م': [
            { subject: 'نظرية آلات 1', instructor: 'أ. أسالم بلعيد', room: '202' },
            { subject: 'إنشاء معماري 2', instructor: 'أ. علي اقزيط', room: '203' },
            { subject: 'رسم معماري', instructor: 'علي هويدي', room: '206' },
            { subject: 'هندسة بيئة 1', instructor: 'أ. سالم خوجة', room: '209' },
            { subject: 'مقاومة مواد 1', instructor: 'أ. طارق شميلة', room: '301' },
            { subject: 'انتقال الحرارة', instructor: 'أ. نور الدين كريم', room: '304' },
            { subject: 'أنظمة تحكم متعددة المتغيرات', instructor: 'أ. أحمد العاتي', room: '310' },
        ],
        '4:00 م - 6:00 م': []
    },
    'الأحد': {
        '8:00 ص - 10:00 ص': [
            { subject: 'تاريخ العمارة', instructor: 'د. فضل المولي', room: '303' },
            { subject: 'ميكانيكا تربة 1', instructor: 'أ. عبدالله غويلة', room: '304' },
            { subject: 'نظم تحكم مثلى', instructor: 'أ. محمد الشريف', room: '308' },
            { subject: 'إشارات ونظم', instructor: 'أ. محمد الشريف', room: '309' },
            { subject: 'فيزياء 1', instructor: 'أ. مريم حمير', room: '202' },
            { subject: 'أحكام الفقه الإسلامي', instructor: 'أ. عمر ابو حجر', room: '203' },
            { subject: 'ميكانيكا هندسية 1', instructor: 'أ. رمضان البتي', room: '301' },
            { subject: 'كيمياء فيزيائية 1', instructor: 'أ. نور الدين كريم', room: '301' },
        ],
        '10:00 ص - 12:00 م': [
            { subject: 'تشييد مباني', instructor: 'محمد شكشك', room: '303' },
            { subject: 'تأهيل منشآت', instructor: 'أ. عبدالله غويلة', room: '304' },
            { subject: 'لغة عربية', instructor: 'د. محمود ابوحجر', room: '307' },
            { subject: 'معمل دوائر 1', instructor: 'د. فتحي البكوش', room: '305' },
            { subject: 'تصميم معماري 3', instructor: 'د. قراض', room: '206' },
            { subject: 'رياضة 1', instructor: 'د. علي فرحات', room: '208' },
            { subject: 'كيمياء', instructor: 'أ. فاطمة ابوتبينة', room: '209' },
        ],
        '12:00 م - 2:00 م': [
            { subject: 'هندسة أساسات', instructor: 'محمد شكشك', room: '303' },
            { subject: 'مواد بناء', instructor: 'علي هويدي', room: '307' },
            { subject: 'تصميم أنظمة تحكم', instructor: 'أ. سالم إعبيد', room: '205' },
            { subject: 'ديناميكا حرارية 2', instructor: 'د. المهدي الحويج', room: '305' },
            { subject: 'رسم هندسي', instructor: 'د. مصطفى أحمد شكشك', room: '206' },
            { subject: 'إدارة المشاريع', instructor: 'أ. احمد شكشك', room: '207' },
            { subject: 'إحصاء', instructor: 'د. علي شكشك', room: '209' },
        ],
        '2:00 م - 4:00 م': [
            { subject: 'لغة إنجليزية 1', instructor: 'د. محمد البحبوح', room: '303' },
            { subject: 'ثقافة وطنية', instructor: 'د. مصطفى الجبو', room: '307' },
            { subject: 'تصميم معماري 4', instructor: 'د. يوسف طاهر', room: '310' },
            { subject: 'انتقال مادة 2', instructor: 'د. المهدي الحويج', room: '305' },
            { subject: 'نظرية إنشاءات 1', instructor: 'أ. أيمن الكوت', room: '203' },
            { subject: 'كميات ومواصفات', instructor: 'أ. أحمد العيان', room: '208' },
            { subject: 'معمل خرسانة', instructor: 'محمد شكشك', room: '209' },
        ],
        '4:00 م - 6:00 م': []
    },
    'الإثنين': {
        '8:00 ص - 10:00 ص': [
            { subject: 'مقدمة هندسة كيميائية', instructor: 'خالد الجفايري', room: '302' },
            { subject: 'كتابة تقارير فنية', instructor: 'أ. محمد ابوسنينة', room: '303' },
            { subject: 'العقيدة والفكر الإسلامي', instructor: 'نوري الطرلي', room: '304' },
            { subject: 'دوائر 1', instructor: 'أ. سالم عوينات', room: '310' },
        ],
        '10:00 ص - 12:00 م': [
            { subject: 'مشروع تخرج', instructor: '-', room: '303' },
            { subject: 'علم الأحياء العام', instructor: 'عبد الطيف الزروقي', room: '306' },
            { subject: 'بحوث العمليات', instructor: 'د. علي شكشك', room: '310' },
        ],
        '12:00 م - 2:00 م': [
            { subject: 'تقنية ورش', instructor: 'أ. مصطفي صوفيا', room: '302' },
            { subject: 'هندسة إنتاج 4', instructor: 'أ. ميلاد التونسي', room: '303' },
            { subject: 'هيدرولوجيا', instructor: 'أ. سالم خوجة', room: '306' },
            { subject: 'تحكم آلي كيميائية', instructor: 'أ. مراجع هندر', room: '309' },
        ],
        '2:00 م - 4:00 م': [
            { subject: 'هندسة إنتاج 2', instructor: 'أ. ميلاد التونسي', room: '303' },
            { subject: 'ميكانيكا الموائع', instructor: 'أ. فرج الكيلاني', room: '306' },
            { subject: 'هندسة تآكل', instructor: 'أ. مراجع هندر', room: '309' },
        ],
        '4:00 م - 6:00 م': []
    },
    'الثلاثاء': {
        '8:00 ص - 10:00 ص': [
            { subject: 'التصميم الهندسي للطرق', instructor: 'أ. محمد بن حليم', room: 'المسرح' },
            { subject: 'كيمياء', instructor: 'أ. صلاح المريمي', room: '202' },
            { subject: 'أحكام الفقه الإسلامي', instructor: 'أ. عمر ابو حجر', room: '203' },
            { subject: 'ميكانيكا تربة 2', instructor: 'أ. عبدالله غويلة', room: '208' },
            { subject: 'تأهيل منشآت', instructor: 'أ. عبدالله غويلة', room: '301' },
            { subject: 'مصفات نفط', instructor: 'أ. محمد سليم فرحات', room: '302' },
            { subject: 'فيزياء 2', instructor: 'أ. محمد ابوسنينة', room: '304' },
        ],
        '10:00 ص - 12:00 م': [
            { subject: 'تصميم معماري 3', instructor: 'د. قراض', room: '305' },
            { subject: 'مساحة 2', instructor: 'أ. محمد بن حليم', room: 'المسرح' },
            { subject: 'تصميم خرسانة 2', instructor: 'أ. أحمد العيان', room: '202' },
            { subject: 'فيزياء معمل', instructor: 'د. مصطفى ديهوم', room: '208' },
            { subject: 'رياضة 4', instructor: 'د. عبد الناصر القعود', room: '301' },
            { subject: 'الذكاء الاصطناعي', instructor: 'سالم عبيد', room: '302' },
            { subject: 'تحكم آلي ميكانيكي', instructor: 'عبد السلام القهواجي', room: '303' },
            { subject: 'رياضة 1', instructor: 'د. عبد الناصر القعود', room: '304' },
        ],
        '12:00 م - 2:00 م': [
            { subject: 'برمجة حاسوب', instructor: 'أ. سالم إعبيد', room: '205' },
            { subject: 'لغة عربية', instructor: 'د. محمود ابوحجر', room: '203' },
            { subject: 'تخطيط عمراني', instructor: 'د. قراض', room: '206' },
            { subject: 'رسومات تنفيذية 1', instructor: 'د. فضل المولي', room: '207' },
        ],
        '2:00 م - 4:00 م': [
            { subject: 'اقتصاد هندسي', instructor: 'أ. مصطفي صوفيا', room: '208' },
        ],
        '4:00 م - 6:00 م': []
    },
    'الأربعاء': {
        '8:00 ص - 10:00 ص': [
            { subject: 'هندسة بيئة 1', instructor: 'أ. سالم خوجة', room: '308' },
            { subject: 'أساسيات دوائر', instructor: 'د. فتحي البكوش', room: '309' },
            { subject: 'تشييد مباني', instructor: 'محمد شكشك', room: '310' },
            { subject: 'التحويل الكهروميكانيكي للطاقة', instructor: 'أ. محمد الشريف', room: '205' },
            { subject: 'لغة إنجليزية 1', instructor: 'د. محمد البحبوح', room: '202' },
            { subject: 'ميكانيكا هندسية 1', instructor: 'أ. رمضان البتي', room: '203' },
            { subject: 'عمارة محلية', instructor: 'د. يوسف طاهر', room: '206' },
            { subject: 'هندسة تآكل', instructor: 'أ. مراجع هندر', room: '209' },
            { subject: 'ثقافة وطنية', instructor: 'د. مصطفى الجبو', room: '301' },
            { subject: 'أساسيات دوائر', instructor: 'د. فتحي البكوش', room: '307' },
            { subject: 'تصميم معماري 2', instructor: 'أ. محمد بن حليم', room: '205' },
            { subject: 'ميكانيكا الموائع', instructor: 'أ. فرج الكيلاني', room: '305' },
        ],
        '10:00 ص - 12:00 م': [
            { subject: 'مقدمة هندسة كيميائية', instructor: 'فرج الكيلاني', room: '306' },
            { subject: 'كيمياء فيزيائية 2', instructor: 'أ. فرج الكيلاني', room: '307' },
            { subject: 'أنظمة رقمية', instructor: 'د. فتحي البكوش', room: '309' },
            { subject: 'هندسة أساسات', instructor: 'محمد شكشك', room: '310' },
            { subject: 'دوائر 2', instructor: 'أ. محمد الشريف', room: '205' },
            { subject: 'فيزياء 1', instructor: 'أ. مريم حمير', room: '202' },
            { subject: 'فيزياء 1', instructor: 'أ. مريم حمير', room: '203' },
            { subject: 'كميات ومواصفات', instructor: 'أ. أحمد العيان', room: '207' },
            { subject: 'ميكانيكا هندسية 1', instructor: 'أ. أسالم بلعيد', room: '208' },
            { subject: 'نظرية إنشاءات 1', instructor: 'أ. أيمن الكوت', room: '303' },
            { subject: 'شبكة أنابيب', instructor: 'أ. عطية بن نجي', room: '304' },
            { subject: 'تخطيط إدارة العمران', instructor: 'مصطفي حكومه', room: '306' },
            { subject: 'طرق تحليلات عددية', instructor: 'د. سعد الغويل', room: '307' },
            { subject: 'ميكانيكا تربة 2', instructor: 'أ. عبدالله غويلة', room: '310' },
            { subject: 'هندسة تفاعلات 2', instructor: 'مصطفى الهليب', room: '305' },
        ],
        '12:00 م - 2:00 م': [
            { subject: 'تصميم أجزاء الآلات', instructor: 'د. معمر حميد', room: '307' },
            { subject: 'تصميم أنظمة تحكم', instructor: 'أ. سالم إعبيد', room: '205' },
            { subject: 'صناعات بتروكيميائية', instructor: 'خالد الجفايري', room: '202' },
            { subject: 'تصميم معماري 1', instructor: 'د. يوسف طاهر', room: '206' },
            { subject: 'إدارة المشاريع', instructor: 'أ. احمد شكشك', room: '207' },
            { subject: 'نظرية آلات 1', instructor: 'أ. أسالم بلعيد', room: '208' },
            { subject: 'كيمياء عضوية', instructor: 'أ. نور الدين كريم', room: '209' },
            { subject: 'إدارة الموارد', instructor: 'د. علي شكشك', room: '301' },
            { subject: 'تصميم مصانع', instructor: 'أ. خالد إعبيد', room: '304' },
            { subject: 'هندسة نقل ومرور', instructor: 'أ. طارق شميلة', room: '306' },
            { subject: 'قياسات كهربية وإلكترونية', instructor: 'سالم عوينات', room: '307' },
            { subject: 'دوائر 1', instructor: 'أ. سالم عوينات', room: '308' },
            { subject: 'معالجات دقيقة 1', instructor: 'د. فتحي البكوش', room: '309' },
            { subject: 'رسم مدني', instructor: 'د. فضل المولي', room: '305' },
        ],
        '2:00 م - 4:00 م': [
            { subject: 'ديناميكا حرارية 1', instructor: 'أ. فرج الكيلاني', room: '306' },
            { subject: 'معمل إلكترونيات', instructor: 'د. سالم الهمالي', room: '205' },
            { subject: 'إنشاء معماري 4', instructor: 'أ. علي اقزيط', room: '305' },
            { subject: 'طرق التحليل الآلي', instructor: 'خالد الجفايري', room: '202' },
            { subject: 'رسم هندسي', instructor: 'د. مصطفى أحمد شكشك', room: '207' },
            { subject: 'إحصاء', instructor: 'د. علي شكشك', room: '208' },
            { subject: 'ميكانيكا هندسية 2', instructor: 'د. احمد العيان', room: '209' },
            { subject: 'ديناميكا حرارية 2', instructor: 'د. المهدي الحويج', room: '301' },
            { subject: 'انتقال مادة 2', instructor: 'د. المهدي الحويج', room: '302' },
            { subject: 'تقنية ورش', instructor: 'أ. مصطفي صوفيا', room: '303' },
        ],
        '4:00 م - 6:00 م': []
    },
    'الخميس': {
        '8:00 ص - 10:00 ص': [
            { subject: 'رياضة 1', instructor: 'د. علي فرحات', room: '203' },
            { subject: 'تصميم داخلي 1', instructor: 'عيسي صوان', room: '206' },
            { subject: 'كيمياء معمل', instructor: 'أ. نور الدين كريم', room: '301' },
            { subject: 'مدخل إلى القرآن', instructor: 'عبد الرحمن خليفة', room: '302' },
            { subject: 'كيمياء عضوية 2', instructor: 'أ. خالد الجفايري', room: '306' },
            { subject: 'تصميم خرسانة 3', instructor: 'محمد شكشك', room: '308' },
            { subject: 'هيدرولوجيا', instructor: 'أ. سالم خوجة', room: '310' },
            { subject: 'تصميم معماري 5', instructor: 'د. فضل المولي', room: '305' },
            { subject: 'أنظمة تحكم حاسوبية', instructor: 'د. سعد الغويل', room: 'المسرح' },
        ],
        '10:00 ص - 12:00 م': [
            { subject: 'أنظمة رقمية', instructor: 'د. فتحي البكوش', room: '207' },
            { subject: 'إحصاء', instructor: 'د. علي شكشك', room: '208' },
            { subject: 'لغة إنجليزية 1', instructor: 'د. محمد البحبوح', room: '209' },
            { subject: 'علم الأحياء العام', instructor: 'عبد الطيف الزروقي', room: '306' },
            { subject: 'خواص مواد', instructor: 'أ. طارق شميلة', room: '308' },
            { subject: 'مقاومة مواد 1', instructor: 'أ. طارق شميلة', room: '309' },
            { subject: 'ميكانيكا موائع 2', instructor: 'أ. سالم خوجة', room: '310' },
        ],
        '12:00 م - 2:00 م': [
            { subject: 'رياضة 2', instructor: 'أ. سالم عوينات', room: '202' },
            { subject: 'تصميم معماري 4', instructor: 'د. يوسف طاهر', room: '206' },
            { subject: 'أنظمة تحكم 1', instructor: 'أ. أحمد العاتي', room: '208' },
            { subject: 'إنتقال الحرارة', instructor: 'أ. نور الدين كريم', room: '209' },
            { subject: 'فيزياء 2', instructor: 'د. مصطفى ديهوم', room: '301' },
            { subject: 'العقيدة والفكر الإسلامي', instructor: 'نوري الطرلي', room: '302' },
            { subject: 'مبادئ هندسة كهربائية', instructor: 'سالم الهمالي', room: '303' },
            { subject: 'ميكانيكا الموائع', instructor: 'أ. فرج الكيلاني', room: '304' },
            { subject: 'أنظمة التحكم اللاخطية', instructor: 'د. سعد الغويل', room: '308' },
            { subject: 'بحوث العمليات', instructor: 'د. علي شكشك', room: '310' },
            { subject: 'تطبيقات حاسوب', instructor: 'عيسي صوان', room: '205' },
            { subject: 'رسم حر', instructor: 'أ. محمد بن حليم', room: '305' },
        ],
        '2:00 م - 4:00 م': [
            { subject: 'ميكانيكا موائع 1', instructor: 'د. احمد العيان', room: '202' },
            { subject: 'ميكانيكا هندسية 2', instructor: 'د. احمد العيان', room: '203' },
            { subject: 'هندسة إنتاج 4', instructor: 'أ. ميلاد التونسي', room: '207' },
            { subject: 'أنظمة تحكم متعددة المتغيرات', instructor: 'أ. أحمد العاتي', room: '208' },
            { subject: 'دوائر 2', instructor: 'أ. محمد الشريف', room: '306' },
        ],
        '4:00 م - 6:00 م': []
    }
};

// --- المكونات ---

const Modal = ({ isOpen, onClose, data }) => {
  if (!isOpen || !data) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" style={{fontFamily: "'IBM Plex Sans Arabic', sans-serif"}}>
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-all">
        <div className="bg-blue-600 p-6 text-white relative">
          <button 
            onClick={onClose} 
            className="absolute top-4 left-4 p-1 rounded-full hover:bg-white/20 transition-colors"
          >
            <X size={24} />
          </button>
          <h2 className="text-2xl font-bold mb-1">{data.subject}</h2>
          <p className="text-blue-100 flex items-center gap-2">
            <User size={16} />
            {data.instructor || 'غير محدد'}
          </p>
        </div>
        <div className="p-6 space-y-4">
          <div className="flex items-center gap-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
            <div className="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full text-blue-600 dark:text-blue-400">
              <Clock size={24} />
            </div>
            <div>
              <p className="text-sm text-slate-500 dark:text-slate-400">الوقت</p>
              <p className="font-semibold text-slate-800 dark:text-slate-100">{data.timeSlot}</p>
            </div>
          </div>
          <div className="flex items-center gap-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
            <div className="bg-amber-100 dark:bg-amber-900/30 p-2 rounded-full text-amber-600 dark:text-amber-400">
              <MapPin size={24} />
            </div>
            <div>
              <p className="text-sm text-slate-500 dark:text-slate-400">القاعة</p>
              <p className="font-semibold text-slate-800 dark:text-slate-100">{data.room}</p>
            </div>
          </div>
          <div className="flex items-center gap-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
            <div className="bg-emerald-100 dark:bg-emerald-900/30 p-2 rounded-full text-emerald-600 dark:text-emerald-400">
              <Calendar size={24} />
            </div>
            <div>
              <p className="text-sm text-slate-500 dark:text-slate-400">اليوم</p>
              <p className="font-semibold text-slate-800 dark:text-slate-100">{data.day}</p>
            </div>
          </div>
        </div>
        <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex justify-end">
          <button 
            onClick={onClose}
            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium w-full md:w-auto"
          >
            إغلاق
          </button>
        </div>
      </div>
    </div>
  );
};

const StatCard = ({ icon: Icon, label, value, color }) => (
  <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col md:flex-row items-center md:items-start text-center md:text-right gap-3 md:gap-4 hover:shadow-md transition-shadow">
    <div className={`p-3 rounded-xl ${color}`}>
      <Icon size={24} className="text-white" />
    </div>
    <div>
      <p className="text-2xl font-bold text-slate-800 dark:text-white">{value}</p>
      <p className="text-xs text-slate-500 dark:text-slate-400">{label}</p>
    </div>
  </div>
);

const App = () => {
  const [activeDay, setActiveDay] = useState('السبت');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedClass, setSelectedClass] = useState(null);
  const [darkMode, setDarkMode] = useState(false);
  const [isListView, setIsListView] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());

  const days = ['السبت', 'الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
  
  // دالة لجلب اسم اليوم الحالي بالعربية
  const getCurrentDayArabic = () => {
    const dayIndex = new Date().getDay(); // 0 is Sunday, 6 is Saturday
    // Mapping: 0: الأحد, 1: الإثنين, ..., 6: السبت
    const dayMap = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    return dayMap[dayIndex];
  };

  // تفعيل الوضع الليلي وتحديث الوقت وتحديد اليوم
  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 60000); // تحديث كل دقيقة

    // تحديد اليوم الحالي عند فتح التطبيق
    const today = getCurrentDayArabic();
    if (days.includes(today)) {
      setActiveDay(today);
    }

    return () => clearInterval(timer);
  }, [darkMode]);

  // دالة قوية للتحقق من الوقت الحالي
  const isTimeCurrent = (timeSlot) => {
    const today = getCurrentDayArabic();
    // يجب أن يكون اليوم المحدد في التبويبات هو اليوم الحالي لكي يظهر البث المباشر
    if (today !== activeDay) return false;

    // تنظيف السلسلة النصية وإزالة المسافات الزائدة
    // المتوقع: "8:00 ص - 10:00 ص" أو "8:00 - 10:00"
    const times = timeSlot.split('-').map(t => t.trim());
    if (times.length !== 2) return false;

    const parseTime = (timeStr) => {
      // إزالة أي رموز غير الأرقام والنقطتين والحروف العربية (ص/م)
      const cleanStr = timeStr.replace(/[^\d:صم]/g, '');
      const match = cleanStr.match(/(\d+):(\d+)(ص|م)?/);
      
      if (!match) return 0;
      
      let [_, h, m, period] = match;
      let hours = parseInt(h);
      let minutes = parseInt(m);
      
      // تحويل إلى نظام 24 ساعة
      // إذا وجدنا "م" (مساءً) والساعة أقل من 12، نضيف 12
      // إذا وجدنا "ص" (صباحاً) والساعة 12، تصبح 0
      // إذا لم نجد (ص/م)، نستخدم التخمين: الساعات 1-6 مساءً (13-18)، 7-12 صباحاً
      if (period === 'م') {
        if (hours < 12) hours += 12;
      } else if (period === 'ص') {
        if (hours === 12) hours = 0;
      } else {
        // Fallback heuristic for when AM/PM is missing
        if (hours < 7) hours += 12; // 1, 2, 3, 4, 5, 6 -> PM
      }
      
      return hours * 60 + minutes;
    };

    const startMinutes = parseTime(times[0]);
    const endMinutes = parseTime(times[1]);
    
    const now = currentTime;
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    return currentMinutes >= startMinutes && currentMinutes < endMinutes;
  };

  // حساب الإحصائيات
  const stats = useMemo(() => {
    const subjects = new Set();
    const instructors = new Set();
    const rooms = new Set();
    let hours = 0;

    Object.values(scheduleData).forEach(day => {
      Object.values(day).forEach(slot => {
        slot.forEach(item => {
          subjects.add(item.subject);
          if (item.instructor && item.instructor !== '-') instructors.add(item.instructor);
          if (item.room) rooms.add(item.room);
          hours += 2;
        });
      });
    });

    return {
      subjects: subjects.size,
      instructors: instructors.size,
      rooms: rooms.size,
      hours
    };
  }, []);

  // تصفية البيانات
  const filteredSchedule = useMemo(() => {
    if (!searchTerm) return scheduleData[activeDay];

    const result = {};
    const term = searchTerm.toLowerCase();

    Object.entries(scheduleData[activeDay]).forEach(([time, items]) => {
      const filteredItems = items.filter(item => 
        item.subject.toLowerCase().includes(term) ||
        (item.instructor && item.instructor.toLowerCase().includes(term)) ||
        item.room.toLowerCase().includes(term)
      );
      if (filteredItems.length > 0) {
        result[time] = filteredItems;
      }
    });
    return result;
  }, [activeDay, searchTerm]);

  return (
    <div className={`min-h-screen bg-slate-50 dark:bg-slate-900 transition-colors duration-300 font-sans text-right`} dir="rtl">
      {/* Inject Google Font */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap');
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; }
      `}</style>

      {/* Header */}
      <header className="bg-gradient-to-l from-blue-900 to-blue-700 text-white pb-20 pt-8 px-4 relative overflow-hidden rounded-b-[2.5rem] shadow-xl">
        <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/3 blur-3xl"></div>
        <div className="absolute bottom-0 left-0 w-96 h-96 bg-amber-500/10 rounded-full translate-y-1/3 -translate-x-1/3 blur-3xl"></div>
        
        <div className="container mx-auto relative z-10">
          <div className="flex flex-row justify-between items-center gap-4 mb-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-md shadow-inner border border-white/20">
                <GraduationCap size={24} className="text-amber-400" />
              </div>
              <div>
                <h1 className="text-lg md:text-2xl font-bold leading-tight">كلية الهندسة</h1>
                <p className="text-blue-200 text-xs md:text-sm">الجامعة الأسمرية</p>
              </div>
            </div>
            <button 
              onClick={() => setDarkMode(!darkMode)}
              className="p-2.5 bg-white/10 hover:bg-white/20 rounded-full backdrop-blur-md transition-all border border-white/10 active:scale-95"
            >
              {darkMode ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>
          
          <div className="max-w-2xl px-1">
            <h2 className="text-3xl md:text-5xl font-bold mb-2 leading-tight">الجدول الدراسي <span className="text-amber-400 block text-2xl md:text-4xl mt-1 font-medium">ربيع 2025</span></h2>
            <p className="text-blue-100/80 text-xs md:text-sm flex items-center gap-1 mt-3">
              <Clock size={12}/>
              آخر تحديث: 13 / 06 / 2025
            </p>
          </div>
        </div>
      </header>

      <main className="container mx-auto px-4 -mt-12 relative z-20 pb-20">
        {/* Stats Grid - Mobile Optimized */}
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6 overflow-x-auto pb-2 scrollbar-hide">
          <StatCard icon={BookOpen} label="مادة" value={stats.subjects} color="bg-blue-500" />
          <StatCard icon={User} label="أستاذ" value={stats.instructors} color="bg-emerald-500" />
          <StatCard icon={MapPin} label="قاعة" value={stats.rooms} color="bg-amber-500" />
          <StatCard icon={Clock} label="ساعة/أسبوع" value={stats.hours} color="bg-purple-500" />
        </div>

        {/* Controls & Filters */}
        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-3 mb-6 sticky top-2 z-30 border border-slate-100 dark:border-slate-700 backdrop-blur-md bg-white/90 dark:bg-slate-800/90 supports-[backdrop-filter]:bg-white/60">
          <div className="flex flex-col gap-3">
            {/* Days Tabs - Horizontal Scroll */}
            <div className="w-full overflow-x-auto pb-1 scrollbar-hide -mx-1 px-1">
              <div className="flex gap-2 min-w-max">
                {days.map(day => (
                  <button
                    key={day}
                    onClick={() => setActiveDay(day)}
                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 whitespace-nowrap border ${
                      activeDay === day 
                      ? 'bg-blue-600 text-white border-blue-600 shadow-md shadow-blue-500/20' 
                      : 'bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600'
                    }`}
                  >
                    {day}
                  </button>
                ))}
              </div>
            </div>

            {/* Search & View Toggle */}
            <div className="flex gap-2">
              <div className="relative flex-1">
                <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input
                  type="text"
                  placeholder="ابحث..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pr-10 pl-4 py-2.5 text-sm bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition-all"
                />
              </div>
              <button 
                onClick={() => setIsListView(!isListView)}
                className="p-2.5 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600"
              >
                {isListView ? <LayoutGrid size={18} /> : <List size={18} />}
              </button>
            </div>
          </div>
        </div>

        {/* Schedule Grid */}
        <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
          {filteredSchedule && Object.keys(filteredSchedule).length > 0 ? (
            Object.entries(filteredSchedule).map(([time, items]) => {
              const isSlotActive = isTimeCurrent(time);
              return (
              <div key={time} className="relative">
                <div className="flex items-center gap-3 mb-3 sticky top-0 z-0">
                  <div className={`px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1.5 border transition-colors duration-500 ${
                    isSlotActive 
                    ? 'bg-red-100 text-red-700 border-red-300 shadow-sm' 
                    : 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-100 dark:border-blue-800'
                  }`}>
                    {isSlotActive ? <Radio size={12} className="animate-pulse text-red-600" /> : <Clock size={12} />}
                    {time}
                    {isSlotActive && <span className="mr-1 text-[10px] bg-red-600 text-white px-1.5 py-0.5 rounded-sm animate-pulse">مباشر الآن</span>}
                  </div>
                  <div className={`h-px flex-1 transition-colors duration-500 ${isSlotActive ? 'bg-red-300' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                </div>
                
                <div className={`grid ${isListView ? 'grid-cols-1' : 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'} gap-3`}>
                  {items.map((item, idx) => (
                    <div 
                      key={idx}
                      onClick={() => setSelectedClass({...item, timeSlot: time, day: activeDay})}
                      className={`group rounded-xl p-4 border shadow-sm hover:shadow-lg transition-all duration-300 cursor-pointer relative overflow-hidden ${
                        isSlotActive 
                        ? 'bg-gradient-to-br from-white to-red-50 dark:from-slate-800 dark:to-red-900/20 border-red-200 dark:border-red-800 ring-1 ring-red-100 dark:ring-red-900/50' 
                        : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-700'
                      }`}
                    >
                      <div className={`absolute top-0 right-0 w-1 h-full transform origin-top scale-y-0 group-hover:scale-y-100 transition-transform duration-300 ${
                        isSlotActive ? 'bg-red-500' : 'bg-blue-500'
                      }`}></div>
                      
                      <div className="flex justify-between items-start gap-2">
                        <h3 className={`font-bold text-base mb-2 line-clamp-2 leading-snug transition-colors ${
                          isSlotActive ? 'text-red-900 dark:text-red-100' : 'text-slate-800 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400'
                        }`}>
                          {item.subject}
                        </h3>
                      </div>
                      
                      <div className="space-y-1.5">
                        <div className="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs">
                          <User size={14} className={isSlotActive ? "text-red-400" : "text-blue-500/70"} />
                          <span className="truncate">{item.instructor || 'غير محدد'}</span>
                        </div>
                        <div className="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs">
                          <MapPin size={14} className={isSlotActive ? "text-red-400" : "text-amber-500/70"} />
                          <span className={`font-medium ${isSlotActive ? 'text-red-700 dark:text-red-300' : 'text-slate-700 dark:text-slate-300'}`}>قاعة {item.room}</span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )})
          ) : (
            <div className="text-center py-16 bg-white dark:bg-slate-800 rounded-3xl border border-dashed border-slate-200 dark:border-slate-700 mx-4">
              <div className="bg-slate-50 dark:bg-slate-700/50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                <Search size={32} className="text-slate-400" />
              </div>
              <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200">لا توجد محاضرات</h3>
              <p className="text-sm text-slate-500 dark:text-slate-400 px-4">لم يتم العثور على أي محاضرات في هذا اليوم أو البحث.</p>
            </div>
          )}
        </div>
      </main>

      {/* Modal */}
      <Modal 
        isOpen={!!selectedClass} 
        onClose={() => setSelectedClass(null)} 
        data={selectedClass} 
      />

      <footer className="bg-slate-900 text-slate-400 py-8 mt-auto border-t border-slate-800">
        <div className="container mx-auto px-4 text-center">
          <p className="mb-2 font-medium text-slate-300">كلية الهندسة - الجامعة الأسمرية الإسلامية</p>
          <p className="text-xs opacity-60">جميع الحقوق محفوظة للطالب زياد أبولائطة © 2025</p>
        </div>
      </footer>
    </div>
  );
};

export default App;
